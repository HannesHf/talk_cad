<!DOCTYPE html>
<html>
<head>
    <title>AI CAD Generator</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 300px; padding: 20px; background: #f0f0f0; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        #viewer { flex-grow: 1; background: #222; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; }
        button { padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #status { margin-top: 20px; font-size: 0.9em; color: #555; white-space: pre-wrap; }
        .warning { color: red; font-weight: bold; margin-top: 10px;}
    </style>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js" type="module"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js" type="module"></script>
</head>
<body>

<div id="sidebar">
    <h2>AI CAD Copilot</h2>
    <p>Beschreibe dein Bauteil:</p>
    <textarea id="prompt" placeholder="z.B. Eine Platte 50x50x5 mit einem Loch (Radius 5) in der Mitte"></textarea>
    <button onclick="generate()">Generieren</button>
    <div id="status">Bereit.</div>
</div>

<div id="viewer"></div>

<script type="module">
    import { STLLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

    // 1. Three.js Setup
    const scene = new THREE.Scene();
    scene.add(new THREE.GridHelper(200, 20)); // Gitter
    
    // Lichter
    const light = new THREE.DirectionalLight(0xffffff, 2);
    light.position.set(10, 10, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / (window.innerWidth - 300), 0.1, 1000);
    camera.position.set(50, 50, 50);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth - 300, window.innerHeight);
    document.getElementById('viewer').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    let currentMesh = null;

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // 2. Funktion zum Aufrufen des Backends
    window.generate = async function() {
        const prompt = document.getElementById('prompt').value;
        const statusDiv = document.getElementById('status');
        
        statusDiv.innerHTML = "Denke nach... (AI generiert Code)";
        
        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.detail || "Fehler");

            statusDiv.innerHTML = "Rendere Modell...";

            // STL Parsen und Anzeigen
            const loader = new STLLoader();
            const geometry = loader.parse(data.stl_data);
            const material = new THREE.MeshPhongMaterial({ color: 0x00ff00, specular: 0x111111, shininess: 200 });
            
            if (currentMesh) scene.remove(currentMesh);
            currentMesh = new THREE.Mesh(geometry, material);
            
            // Zentrieren
            geometry.computeBoundingBox();
            geometry.center();
            
            scene.add(currentMesh);
            
            // Output anzeigen
            let msg = `✅ Fertig!\nVolumen: ${data.analysis.volume}mm³`;
            if (data.analysis.warning) {
                msg += `\n⚠️ ${data.analysis.warning}`;
            }
            statusDiv.innerHTML = msg;

        } catch (e) {
            statusDiv.innerHTML = "❌ Fehler: " + e.message;
        }
    };
</script>
</body>
</html>